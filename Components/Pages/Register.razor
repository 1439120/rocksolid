@page "/register"
@rendermode InteractiveServer
@using BlazorApp.Models
@inject IJSRuntime JS
@inject ClientDatabaseService ClientDbService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nvManager
@inject FirebaseAuthentication FirebaseAuth

<div class="register-wrapper d-flex justify-content-center align-items-center">
    <div class="register-card bg-white shadow-lg rounded-4 p-4">

        <h3 class="text-center mb-4 text-primary fw-bold">Create Your RockSolid Account</h3>
        <p class="text-center text-muted mb-4">Join RockSolid to manage and track your loans securely</p>

        <EditForm Model="User" OnValidSubmit="CreateUser">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger mb-3" />
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label fw-semibold">First Name</label>
                    <InputText id="name" @bind-Value="User.Name" class="form-control form-control-lg" placeholder="Enter your first name" />
                    <ValidationMessage For="() => User.Name" class="text-danger small" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="surname" class="form-label fw-semibold">Last Name</label>
                    <InputText id="surname" @bind-Value="User.Surname" class="form-control form-control-lg" placeholder="Enter your last name" />
                    <ValidationMessage For="() => User.Surname" class="text-danger small" />
                </div>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label fw-semibold">Email Address</label>
                <InputText id="email" @bind-Value="User.Email" class="form-control form-control-lg" placeholder="Enter your email" />
                <ValidationMessage For="() => User.Email" class="text-danger small" />
            </div>

            <div class="mb-3">
                <label for="password" class="form-label fw-semibold">Password</label>
                <InputText id="password" @bind-Value="User.Password" type="password" class="form-control form-control-lg" placeholder="Create a password" />
                <ValidationMessage For="() => User.Password" class="text-danger small" />
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label fw-semibold">Confirm Password</label>
                <InputText id="confirmPassword" @bind-Value="ConfirmPassword" type="password" class="form-control form-control-lg" placeholder="Re-enter your password" />
                <ValidationMessage For="() => ConfirmPassword" class="text-danger small" />
            </div>

            @if (!string.IsNullOrEmpty(Message))
            {
                <p class="text-danger text-center">@Message</p>
            }

            <button type="submit" class="btn btn-primary w-100 py-2 fs-6 fw-semibold">
                Register
            </button>

            <div class="text-center mt-4">
                <span class="text-muted">Already have an account?</span>
                <a href="/login" class="text-primary text-decoration-none fw-semibold ms-1">
                    Login here
                </a>
            </div>
        </EditForm>
    </div>
</div>

@code{
    public ClientDatabase User = new ClientDatabase();
    private string ConfirmPassword { get; set; } = string.Empty;
    public string Message = "";

    private async Task CreateUser()
    {
        
        try
        {
            var userId = await FirebaseAuth.Register(User.Email, User.Email);
            if(FirebaseAuth.Message.Length > 0 && userId.Length == 0){
                throw new Exception(FirebaseAuth.Message);
            }
            Console.WriteLine("Registered to firebase successfully!: ", userId);
            User.UserId = userId;
            Console.WriteLine("User: {0}", System.Text.Json.JsonSerializer.Serialize(User));
            await ClientDbService.AddUserAsync(User);
            Console.WriteLine("User created successfully");
            var customAuthStateProvider = (CustomAuthenticationProvider)authStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession{
                UserName=User.Email,
                UserID=User.UserId,
                Role="Admin"
            });
            nvManager.NavigateTo("/dashboard", true);
        }
        catch (Exception ex)
        {
            Message = ex.Message;
            Console.WriteLine($"Error: {ex.Message}");        
        }
    }
}