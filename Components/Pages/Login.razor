@page "/login"
@rendermode InteractiveServer
@using BlazorApp.Services
@using BlazorApp.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Models;
@using System.ComponentModel.DataAnnotations
@inject FirebaseAuthentication FirebaseAuth
@inject IJSRuntime js
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nvManager


<div class="login-wrapper d-flex justify-content-center align-items-center">
    <div class="login-card bg-white shadow-lg rounded-4 p-4">

        <h3 class="text-center mb-4 text-primary fw-bold">Welcome to RockSolid</h3>
        <p class="text-center text-muted mb-4">Sign in to manage your loans securely</p>

        <EditForm Model="User" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger mb-3" />

            <div class="mb-3 position-relative">
                <label for="email" class="form-label fw-semibold">Email address</label>
                <InputText id="email" @bind-Value="User.Email" class="form-control form-control-lg" placeholder="Enter your email" />
                <ValidationMessage For="() => User.Email" class="text-danger small" />
            </div>

            <div class="mb-3 position-relative">
                <label for="password" class="form-label fw-semibold">Password</label>
                <InputText id="password" @bind-Value="User.Password" type="password" class="form-control form-control-lg" placeholder="Enter your password" />
                <ValidationMessage For="() => User.Password" class="text-danger small" />
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                    <InputCheckbox @bind-Value="RememberMe" class="form-check-input" id="rememberMe" />
                    <label class="form-check-label text-muted" for="rememberMe">Remember me</label>
                </div>
                <a href="/forgot-password" class="text-decoration-none small text-primary">Forgot password?</a>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-2 fs-6 fw-semibold">
                Login
            </button>

            <div class="text-center mt-4">
                <span class="text-muted">Don't have an account?</span>
                <a href="/register" class="text-primary text-decoration-none fw-semibold ms-1">
                    Register here
                </a>
            </div>
        </EditForm>
    </div>
</div>


<p>@message</p>

@code {
    private bool RememberMe { get; set; } = false;
    private UserModel User = new();
    private string message = "";

    private async Task HandleLogin()
    {
        var UserId = await FirebaseAuth.Login(User.Email, User.Password);
        message = FirebaseAuth.Message;
        if(!FirebaseAuth.IsLoggedIn){
            await js.InvokeVoidAsync("alert", "Invalid user name or password");
            return;
        }
        @* Find the user that is logged in *@

        var customAuthStateProvider = (CustomAuthenticationProvider)authStateProvider;
        await customAuthStateProvider.UpdateAuthenticationState(new UserSession{
            UserName=User.Email,
            UserID=UserId,
            Role="Admin"
        });
        nvManager.NavigateTo("/dashboard", true);
    }

    public class UserModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(6)]
        public string Password { get; set; } = string.Empty;
    }
}    

