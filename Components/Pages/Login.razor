@page "/login"
@rendermode InteractiveServer
@using BlazorApp.Services
@using BlazorApp.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Models;
@using System.ComponentModel.DataAnnotations
@inject FirebaseAuthentication FirebaseAuth
@inject IJSRuntime js
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nvManager
@inject ClientDatabaseService ClientDbService


<div class="login-wrapper d-flex justify-content-center align-items-center">
    <div class="login-card bg-white shadow-lg rounded-4 p-4">

        <h3 class="text-center mb-4 text-primary fw-bold">Welcome to RockSolid</h3>
        <p class="text-center text-muted mb-4">Sign in to manage your loans securely</p>

        <EditForm Model="User" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger mb-3" />

            <div class="mb-3 position-relative">
                <label for="email" class="form-label fw-semibold">Email address</label>
                <InputText id="email" @bind-Value="User.Email" class="form-control form-control-lg" placeholder="Enter your email" />
                <ValidationMessage For="() => User.Email" class="text-danger small" />
            </div>

            <div class="mb-3 position-relative">
                <label for="password" class="form-label fw-semibold">Password</label>
                <InputText id="password" @bind-Value="User.Password" @onfocus="ClearErrors" type="password" class="form-control form-control-lg" placeholder="Enter your password" />
                <ValidationMessage For="() => User.Password" class="text-danger small" />
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                    <InputCheckbox @bind-Value="RememberMe" class="form-check-input" id="rememberMe" />
                    <label class="form-check-label text-muted" for="rememberMe">Remember me</label>
                </div>
                <a href="/forgot-password" class="text-decoration-none small text-primary">Forgot password?</a>
            </div>

            <div>
                <P class="text-danger">@message</P>
            </div>

            <button type="submit" disabled="@isLoaing" class="btn btn-primary w-100 py-2 fs-6 fw-semibold">
                Login
            </button>

            <div class="text-center mt-4">
                <span class="text-muted">Don't have an account?</span>
                <a href="/register" class="text-primary text-decoration-none fw-semibold ms-1">
                    Register here
                </a>
            </div>
        </EditForm>
    </div>
</div>


<p>@message</p>

@code {
    private bool RememberMe { get; set; } = false;
    private UserModel User = new();
    private string message = "";
    bool isLoaing = false;

    private async Task HandleLogin()
    {
        message = "";
        isLoaing = true;
        var UserId = await FirebaseAuth.Login(User.Email, User.Password);
        @* message = FirebaseAuth.Message; *@
        
        if(!FirebaseAuth.IsLoggedIn){
            @* await js.InvokeVoidAsync("alert", "Invalid user name or password"); *@
            message = "Invalid user name or password";
            isLoaing = false;
            return;
        }
        Console.WriteLine("Firebase authentication passed");
        @* Find the user that is logged in *@
        var LoggedUser = (await ClientDbService.GetClientByUserId(UserId)).FirstOrDefault();

        if(LoggedUser != null){
            var customAuthStateProvider = (CustomAuthenticationProvider)authStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession{
                UserName=LoggedUser.Email,
                UserID=LoggedUser.UserId,
                Role=LoggedUser.Role
            });
            nvManager.NavigateTo("/dashboard", true);
            Console.WriteLine("User successfully logged in");
            Console.WriteLine($"Role: {LoggedUser.Role}");
        }
        
    }

    private void ClearErrors(){
        message = "";
    }

    public class UserModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;
    }
}    

